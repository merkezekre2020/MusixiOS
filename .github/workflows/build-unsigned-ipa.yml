name: Build Unsigned IPA

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build Configuration'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
      scheme:
        description: 'Xcode Scheme (leave empty for auto-detect)'
        required: false
        default: ''
        type: string

jobs:
  build-unsigned-ipa:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Check Xcode Version
        run: |
          xcodebuild -version
      
      - name: Find Xcode Project
        id: find_project
        run: |
          # Look for .xcodeproj files
          PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1)
          
          if [ -z "$PROJECT_FILE" ]; then
            echo "No .xcodeproj found in root directory. Checking subdirectories..."
            PROJECT_FILE=$(find . -name "*.xcodeproj" -type d | head -n 1)
          fi
          
          if [ -z "$PROJECT_FILE" ]; then
            echo "::error::No Xcode project found!"
            exit 1
          fi
          
          PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
          echo "Found project: $PROJECT_NAME"
          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "project_path=$PROJECT_FILE" >> $GITHUB_OUTPUT
      
      - name: List Available Schemes
        run: |
          echo "Available schemes in project:"
          xcodebuild -project "${{ steps.find_project.outputs.project_path }}" -list 2>&1 | grep -A 20 "Schemes:" || echo "Could not list schemes"
      
      - name: Auto-detect Scheme
        id: detect_scheme
        run: |
          PROJECT_NAME="${{ steps.find_project.outputs.project_name }}"
          
          # Use provided scheme or auto-detect
          if [ -n "${{ github.event.inputs.scheme }}" ]; then
            SCHEME="${{ github.event.inputs.scheme }}"
          else
            SCHEME="$PROJECT_NAME"
          fi
          
          echo "Using scheme: $SCHEME"
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
      
      - name: Create Build Directory
        run: mkdir -p build
      
      - name: Install xcpretty
        run: gem install xcpretty
      
      - name: Build Project (Verify Compilation)
        run: |
          PROJECT_NAME="${{ steps.find_project.outputs.project_name }}"
          SCHEME="${{ steps.detect_scheme.outputs.scheme }}"
          CONFIGURATION="${{ github.event.inputs.configuration }}"
          
          echo "=== Step 1: Verifying compilation ==="
          echo "Project: ${{ steps.find_project.outputs.project_path }}"
          echo "Scheme: $SCHEME"
          echo "Configuration: $CONFIGURATION"
          
          # First do a simple build to verify it compiles
          xcodebuild build \
            -project "${{ steps.find_project.outputs.project_path }}" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination "platform=iOS Simulator,name=iPhone 15" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build/build-check.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "::error::Build verification failed with exit code $BUILD_STATUS"
            echo "=== Build log ==="
            cat build/build-check.log
            exit 1
          fi
          
          echo "✅ Build verification successful"
      
      - name: Build Archive (Unsigned)
        run: |
          PROJECT_NAME="${{ steps.find_project.outputs.project_name }}"
          SCHEME="${{ steps.detect_scheme.outputs.scheme }}"
          CONFIGURATION="${{ github.event.inputs.configuration }}"
          ARCHIVE_PATH="$(pwd)/build/$PROJECT_NAME.xcarchive"
          
          echo "=== Step 2: Creating archive ==="
          echo "Archive path: $ARCHIVE_PATH"
          
          # Remove any existing archive
          rm -rf "$ARCHIVE_PATH"
          
          # Build archive
          xcodebuild archive \
            -project "${{ steps.find_project.outputs.project_path }}" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            -destination "generic/platform=iOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_BITCODE=NO \
            2>&1 | tee build/xcodebuild-archive.log | xcpretty --color
          
          ARCHIVE_STATUS=${PIPESTATUS[0]}
          
          if [ $ARCHIVE_STATUS -ne 0 ]; then
            echo "::error::Archive creation failed with exit code $ARCHIVE_STATUS"
            echo "=== Archive log ==="
            cat build/xcodebuild-archive.log
            exit 1
          fi
          
          # Verify archive was created
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "::error::Archive directory not found at: $ARCHIVE_PATH"
            echo "Current directory: $(pwd)"
            echo "Build directory contents:"
            ls -la build/
            exit 1
          fi
          
          echo "✅ Archive created successfully at: $ARCHIVE_PATH"
          echo "Archive contents:"
          ls -la "$ARCHIVE_PATH"
      
      - name: Create IPA from Archive
        run: |
          PROJECT_NAME="${{ steps.find_project.outputs.project_name }}"
          ARCHIVE_PATH="$(pwd)/build/$PROJECT_NAME.xcarchive"
          
          echo "Looking for archive at: $ARCHIVE_PATH"
          
          # Check archive exists
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "::error::Archive not found at $ARCHIVE_PATH"
            echo "Current directory: $(pwd)"
            echo "Contents of build directory:"
            ls -la build/
            exit 1
          fi
          
          echo "Archive found at: $ARCHIVE_PATH"
          echo "Archive structure:"
          find "$ARCHIVE_PATH" -type d | head -20
          
          # Find .app bundle in archive
          APP_BUNDLE=$(find "$ARCHIVE_PATH" -name "*.app" -type d | head -n 1)
          
          if [ -z "$APP_BUNDLE" ]; then
            echo "::error::No .app bundle found in archive"
            echo "Full archive structure:"
            ls -laR "$ARCHIVE_PATH/" | head -50
            exit 1
          fi
          
          echo "Found app bundle: $APP_BUNDLE"
          
          # Check app bundle validity
          if [ ! -d "$APP_BUNDLE" ]; then
            echo "::error::App bundle is not a valid directory"
            exit 1
          fi
          
          # Create Payload directory
          mkdir -p build/Payload
          
          # Copy .app bundle to Payload
          cp -R "$APP_BUNDLE" "build/Payload/"
          
          if [ $? -ne 0 ]; then
            echo "::error::Failed to copy app bundle to Payload"
            exit 1
          fi
          
          echo "App bundle copied to Payload"
          ls -la build/Payload/
          
          # Create IPA (unsigned)
          cd build
          zip -r "${PROJECT_NAME}-unsigned.ipa" Payload
          cd ..
          
          echo "IPA created: build/${PROJECT_NAME}-unsigned.ipa"
      
      - name: Display IPA Info
        run: |
          PROJECT_NAME="${{ steps.find_project.outputs.project_name }}"
          IPA_PATH="build/${PROJECT_NAME}-unsigned.ipa"
          
          echo "=== IPA Details ==="
          ls -lh "$IPA_PATH"
          
          # Extract and display app bundle info
          unzip -q "$IPA_PATH" -d build/extracted
          APP_BUNDLE=$(find build/extracted/Payload -name "*.app" | head -n 1)
          
          if [ -f "$APP_BUNDLE/Info.plist" ]; then
            echo ""
            echo "=== App Bundle Info ==="
            plutil -p "$APP_BUNDLE/Info.plist" | grep -E "(CFBundleIdentifier|CFBundleVersion|CFBundleShortVersionString)" || true
          fi
          
          # Cleanup
          rm -rf build/extracted
      
      - name: Upload Unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa-${{ github.event.inputs.configuration }}
          path: build/*-unsigned.ipa
          retention-days: 7
      
      - name: Summary
        run: |
          echo "## ✅ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:** ${{ github.event.inputs.configuration }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scheme:** ${{ steps.detect_scheme.outputs.scheme }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ steps.find_project.outputs.project_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The unsigned IPA has been uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ⚠️ Note" >> $GITHUB_STEP_SUMMARY
          echo "This is an **unsigned** IPA. To install on a device, you need to:" >> $GITHUB_STEP_SUMMARY
          echo "1. Sign it with a valid Apple Developer certificate, OR" >> $GITHUB_STEP_SUMMARY
          echo "2. Use a tool like [AltStore](https://altstore.io/) or [Sideloadly](https://sideloadly.io/)" >> $GITHUB_STEP_SUMMARY
